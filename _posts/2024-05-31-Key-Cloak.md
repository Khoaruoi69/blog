---
layout: post
title: Cài đặt KeyCloak standalone server
categories: KeyCloak
---

### Dowload KeyCloak

- Tại: https://www.keycloak.org/downloads.html. (*download tập tin Keycloak server (Distribution powered by Quarkus) *)

- Start Keycloak vào thư mục bin mở console trên Window, Terminal trên Linux và macOS

![_config.yml]({{ site.baseurl }}/images/keycloak-01.png)

+ Development:  ./kc.bat start-dev
+ Production:   ./kc.bat start

- Muốn change ports thì dùng: kc.bat start-dev --http-port 8180

Start thành công:

![_config.yml]({{ site.baseurl }}/images/keycloak-02.png)

![_config.yml]({{ site.baseurl }}/images/keycloak-03.png)

- Create an administrative user
+ Username: Admin
+ Password: Admin@123

- Tạo thành công

![_config.yml]({{ site.baseurl }}/images/keycloak-04.png)


### Tạo Realm

#### Realm là gì ? 

- Realm là một khái niệm trong Keycloak để chỉ một đối tượng quản lý một tập các user cùng với thông tin đăng nhập, role và group của những user đó. 
- Một user trong Keycloak chỉ thuộc về một realm và user khi đăng nhập vào Keycloak sẽ đăng nhập vào realm của user đó. 
- Chúng ta có thể có nhiều realm trong một Keycloak server, các realm này sẽ độc lập với nhau và chúng chỉ manage users của chúng.

- Realm được khởi tạo lúc đầu (administrative)  là Realm có quyền cao nhất trong các realm của Keycloak server, user admin sẽ có quyền xem và quản lý các realm khác.
Ko nên dùng master Realm này để quản lý User và các thông tin khác của chúng trong KeyCloak.  Nó chỉ nên được sử dụng để user admin của nó tạo và quản lý các realm khác. Mỗi realm cần phải có user admin riêng và chúng ta sẽ sử dụng user admin của từng realm để quản lý users cho realm đó.

- Bắt đầu tạo 1 realm mới

![_config.yml]({{ site.baseurl }}/images/keycloak-05.png)

- Điền các thông tin cần tạo và nhấn Create là thành công

![_config.yml]({{ site.baseurl }}/images/keycloak-06.png)


### Thêm mới client trong Keycloak

- Client trong Keycloak là những ứng dụng sẽ tương tác với nó để authentication và authorization.
- Việc thêm mới client trong Keycloak là để nó quản lý tất cả những client sẽ connect tới nó, theo giao thức, chuẩn authentication và authorization nào.


- Đầu tiên đăng nhập vào realm mà các bạn muốn thêm mới client

![_config.yml]({{ site.baseurl }}/images/keycloak-07.png)

- Nhấn vào menu item Client 

![_config.yml]({{ site.baseurl }}/images/keycloak-08.png)

![_config.yml]({{ site.baseurl }}/images/keycloak-09.png)

- Để thêm mới một client, các bạn hãy nhấn vào nút Create client trong trang này. Một trang Create Client General Settings sẽ hiển thị như sau:

![_config.yml]({{ site.baseurl }}/images/keycloak-10.png)

Các bạn hãy điền thông tin client sử dụng các field Client type, Client ID, Name và Description.

Ở field Client type, chúng ta có 2 type mà Keycloak hỗ trợ là OpenID Connect (một extension của chuẩn OAuth) và SAML (Security Assertion Markup Language), tuỳ theo mục đích của mình mà các bạn chọn cho hợp lý nhé!

- **Giả sử bây giờ mình có một ứng dụng Angular tên là angular-test, mình muốn sử dụng Keycloak để quản lý việc authentication và authorization theo chuẩn OAuth2. Cho Angular application, chúng ta sẽ sử dụng grant type Authorization Code với PKCE của OAuth2.**

Để khai báo client cho ứng dụng Angular này vào Keycloak, mình sẽ điền thông tin của nó như sau:

![_config.yml]({{ site.baseurl }}/images/keycloak-11.png)

- Tuỳ theo type mà các bạn sử dụng cho ứng dụng của mình, chúng ta có thể cần phải khai báo thêm những thông tin cần thiết liên quan đến type đó
-  Đối với type OpenID Connect, chúng ta sẽ cần khai báo thêm thông tin, sử dụng nút Next

- Nhấn nút Next, các bạn sẽ thấy Keycloak hiển thị trang **Capability config** như sau:

![_config.yml]({{ site.baseurl }}/images/keycloak-12.png)

- Mặc định thì đối với type OpenID Connect, Keycloak sẽ tạo mới một client hỗ trợ Authorization Code và Resource Owner Password Credentials grant type của OAuth2 nên các bạn thấy field Standard flow và Direct access grants được chọn. 

- Keycloak còn hỗ trợ Implicit Flow (field Implicit flow),  
Client Credentials (field Service accounts roles)
 và Device Authorization (field OAuth 2.0 Device Authorization Grant) của OAuth 2, 
 CIBA flow (field OIDC CIBA Grant) một chuẩn extend OpenID Connect.

 - Mình sẽ không sử dụng **Resource Owner Password Credentials grant type** cho Angular application của mình nên mình sẽ bỏ chọn grant type này đi!

- Ở đây, các bạn còn có thể thấy 2 field **Client authentication** và **Authorization** đang được turn off. Client authentication field liên quan đến access type của client, mặc định “off” có nghĩa là access type là public, “on” là confidential nha các bạn! Liên quan đến access type của client các bạn có thể đọc thêm ở đây.

- Authorization field thì liên quan đến việc hỗ trợ authorization, định nghĩa scope, authorization policies, cho client của chúng ta!

- Cho Angular application, access type nên là public và không hỗ trợ Authorization nên mình sẽ không turn on 2 field này các bạn nhé!

- Chúng ta có thể enable hay disable client này bằng field Enabled và có rất nhiều field mà chúng ta có thể cấu hình cho thông tin của một client.

- Cho Angular application, trong phần Login settings, các bạn nên cấu hình field Valid redirect URIs. Ở local, giá trị của field này có thể là: http://localhost:4200/* như sau:

![_config.yml]({{ site.baseurl }}/images/keycloak-13.png)

- Chúng ta cũng có thể thay đổi theme cho trang login của user bằng field Login Theme trong phần Login Settings.

- Trong tab Advanced, phần Advanced Settings, các bạn có thể cấu hình Code Exchange method của grant type Authorization Code với PKCE nếu muốn

![_config.yml]({{ site.baseurl }}/images/keycloak-14.png)

- Mặc định nếu chúng ta không cấu hình cho field này thì Keycloak sẽ không apply PKCE cho client này, trừ khi client gửi code exchange và code challenge method.

- Sau khi cấu hình xong thông tin cho Client thì các bạn hãy click nút Save để lưu lại những cấu hình đó nhé!

- Trong bài viết này, mình chỉ đề cập những thông tin cấu hình cơ bản của một Client được tạo trong Keycloak sử dụng grant type Authorization Code với PKCE. Tuỳ theo grant type mà client hỗ trợ thì còn nhiều thông tin, cấu hình khác nữa. Tuỳ nhu cầu, các bạn hãy tìm hiểu thêm nhé!

---------------------------------------------------------------------------

### Thêm mới client hỗ trợ grant type Authorization Code của OAuth2 trong Keycloak

Mình đã giới thiệu với các bạn cách thêm mới một client trong Keycloak và cũng đã hướng dẫn các bạn cấu hình một client hỗ trợ grant type Authorization Code với PKCE của OAuth2 là như thế nào. Trong bài viết này, mình sẽ giới thiệu với các bạn cách thêm mới và cấu hình client hỗ trợ grant type Authorization Code của OAuth2 trong Keycloak các bạn nhé!

Giả sử mình đã tạo mới một client tên là huongdanjava_authorization_code trong Keycloak như sau:

![_config.yml]({{ site.baseurl }}/images/keycloak-15.png)

- Mặc định client này sẽ support Authorization Code và Resource Owner Password Credentials grant type của OAuth2 nên các bạn thấy field Standard flow và Direct access grants được chọn.

- Chúng ta sẽ disable Resource Owner Password Credentials grant type đi và turn on 2 field Client authentication và Authorization để client của chúng ta là Confidential và chúng ta có thể sử dụng access token của nó để làm authorization:

![_config.yml]({{ site.baseurl }}/images/keycloak-16.png)

- Vì trong Authorization Code grant type, sau khi user login, trang grant quyền access, consent screen, sẽ được hiển thị, các bạn có thể turn on hoặc turn off trang consent screen này bằng field Consent required trong phần Login settings. 
- Mình sẽ turn on field này để làm ví dụ:

![_config.yml]({{ site.baseurl }}/images/keycloak-17.png)

- Chúng ta có thể thay đổi theme cho trang login của user bằng field Login theme cũng trong phần Login settings này.
- Nói thêm cho các bạn biết là Keycloak hỗ trợ chúng ta custom login theme mặc định của Keycloak và nhiều thứ khác nữa, các bạn có thể tìm hiểu thêm trên mạng các bạn nhé!

- Một thông tin required khác cho **Authorization Code grant type** mà chúng ta cần cấu hình là **Redirect URIs** sử dụng field **Valid redirect URIs**. Redirect URIs này sẽ những valid URI mà Keycloak có thể sử dụng cho client này để trả về authorization code sau khi user login và grant access cho Client Application.

-  Mình sẽ sử dụng https://oidcdebugger.com/ để làm ví dụ cho bài viết này nên mình sẽ cấu hình Redirect URI là https://oidcdebugger.com/debug như sau:

![_config.yml]({{ site.baseurl }}/images/keycloak-18.png)

- Nhấn nút Save
- Thông tin client secret của client này sẽ nằm trong tab Credentials:

![_config.yml]({{ site.baseurl }}/images/keycloak-19.png)

- Đến đây thì chúng ta đã hoàn thành những cấu hình cơ bản cho client với Authorization Code grant type rồi đó các bạn!

- Để kiểm tra kết quả, đầu tiên các bạn có thể sử dụng https://oidcdebugger.com/ đóng vai trò là một Client Application để lấy authorization code với cấu hình như sau:

![_config.yml]({{ site.baseurl }}/images/keycloak-20.png)

- Authorize URI của Keycloak là http://localhost:8080/realms/RealmTest01/protocol/openid-connect/auth 

- với http://localhost:8080:  là tên server và port number mà Keycloak chúng ta đang sử dụng, đang chạy.

- RealmTest01:  là tên realm mà client của các bạn được định nghĩa.

- Chúng ta sẽ không thay đổi Redirect URI mặc định của https://oidcdebugger.com/ các bạn nhé!

- Client ID là client mà mình vừa mới tạo ở trên.
- Sau khi đã nhập những thông tin trên thì các bạn hãy nhấn nút Send Request ở dưới cùng của trang này. Trang đăng nhập thông tin user sẽ hiển thị như sau:

![_config.yml]({{ site.baseurl }}/images/keycloak-32.png)


- Yes có nghĩa là các bạn đồng ý cho Client Application truy cập những thông tin được hiển thị trong trang này, ngược lại, nếu các bạn đổi ý thì có thể nhấn nút No các bạn nhé!

- Sau khi nhấn nút Yes, authorization code sẽ được trả về cho Client Application https://oidcdebugger.com như sau:

![_config.yml]({{ site.baseurl }}/images/keycloak-33.png)

- Các bạn có thể sử dụng authorization code này cùng với client secret của client để request tới Keycloak lấy access token như sau:

CRUL:

![_config.yml]({{ site.baseurl }}/images/keycloak-34.png)



-----------------------------------------------

### Tạo mới user trong Keycloak

- Để sử dụng các application mà chúng sử dụng Keycloak cho authentication và authorization, chúng ta cần có user để đăng nhập

- Thông thường ở các hệ thống lớn thì thông tin user sẽ được lưu trữ trong Active Directory (AD) hoặc LDAP, Keycloak có thể kết nối tới các hệ thống này để lấy thông tin user

- Nó cũng có thể lưu trữ thông tin user trực tiếp luôn. Trong bài viết này, mình sẽ hướng dẫn các bạn cách tạo mới user trong Keycloak!

- Đầu tiên, các bạn cần login vào Keycloak bằng tài khoản admin, sau đó thì chọn menu item Users ở bên trái. Nội dung trang Users sẽ hiển thị như sau:

![_config.yml]({{ site.baseurl }}/images/keycloak-21.png)

![_config.yml]({{ site.baseurl }}/images/keycloak-22.png)

- Username là tên user dùng để đăng nhập và đây là thông tin bắt buộc chúng ta phải nhập nhé các bạn!

- Email là email của user.

- Email Verified thì cho phép chúng ta xác nhận là email của user đã xác nhận hay chưa? ON là đã xác nhận còn OFF là chưa nha các bạn!

- First Name và Last Name là tên của user.

- Các bạn có thể enable hoặc disable user sử dụng ô Enabled với giá trị ON hoặc OFF.

- Required user actions định nghĩa một số thao tác:

![_config.yml]({{ site.baseurl }}/images/keycloak-23.png)

- mà nếu các bạn muốn thì có thể chọn để user làm.

- Sau khi điền đầy đủ thông tin, các bạn có thể nhấn nút Create để hoàn tất việc tạo mới.

- Ví dụ của mình như sau:

![_config.yml]({{ site.baseurl }}/images/keycloak-24.png)

- Kết quả:

![_config.yml]({{ site.baseurl }}/images/keycloak-25.png)

- Để cập nhập thông tin mật khẩu đăng nhập, các bạn hãy đi đến tab Credentials trong cửa sổ này rồi nhấn nút Set password:

![_config.yml]({{ site.baseurl }}/images/keycloak-26.png)

- Các bạn hãy nhập Password và Password Confirmation.

- Nếu đây chỉ là password tạm thời, user cần thay đổi password khi login thì các bạn hãy để ô Temporary mặc định với giá trị ON, ngược lại thì hãy OFF nó.

![_config.yml]({{ site.baseurl }}/images/keycloak-27.png)

- Cuối cùng thì các bạn hãy nhấn nút Save để lưu lại mật khẩu này. Cửa sổ sau sẽ xuất hiện:

![_config.yml]({{ site.baseurl }}/images/keycloak-28.png)

- để xác nhận rằng bạn thật sự muốn đặt mật khẩu cho user này.

- Tiếp tục nhấn nút Save password để xác nhận các bạn nhé!

- Kết quả:

![_config.yml]({{ site.baseurl }}/images/keycloak-29.png)

- Đến đây thì các bạn có thể sử dụng user này để đăng nhập vào Keycloak server sử dụng URL http://localhost:8080/realms/huongdanjava/account/#/ 
- với huongdanjava là tên realms mà mình đang sử dụng. Các bạn sẽ thấy kết quả như sau:
- Nhấn nút Sign In, sau đó nhập thông tin user mà các bạn vừa mới tạo. Nếu password mà các bạn vừa mới set là password tạm, các bạn sẽ thấy Keycloak yêu cầu change password như sau:

![_config.yml]({{ site.baseurl }}/images/keycloak-31.png)

- Sau khi nhập password mới, các bạn sẽ thấy kết quả như sau: 
 
![_config.yml]({{ site.baseurl }}/images/keycloak-30.png)